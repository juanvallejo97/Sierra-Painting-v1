# Firebase Configuration Guide

## Overview

This document describes the Firebase setup for the Sierra Painting mobile application.

## Current Configuration Status

### ✅ Configured Components

1. **Firebase Options** (`lib/firebase_options.dart`)

   - Generated by FlutterFire CLI
   - Supports Android, iOS, macOS, and Web platforms
   - Contains platform-specific API keys and project configuration

2. **Firebase Initialization** (`lib/main.dart`)

   - Properly initialized before app launch
   - App Check enabled for production security
   - Performance monitoring configured
   - Crashlytics error tracking active

3. **Firebase Services Active**
   - **Authentication**: Email/password provider
   - **Firestore**: Primary database with offline persistence
   - **Cloud Functions**: Backend business logic
   - **Storage**: File and photo uploads
   - **Remote Config**: Feature flags
   - **Performance**: App performance monitoring
   - **Crashlytics**: Crash and error reporting
   - **Analytics**: User behavior tracking

### ⚠️ Platform-Specific Configuration Files

The following files are required for Firebase to work on each platform but are typically excluded
from version control for security:

- `android/app/google-services.json` - Android configuration
- `ios/Runner/GoogleService-Info.plist` - iOS configuration

**Note**: These files contain client-side configuration only (safe to commit) but may be gitignored
to prevent accidental exposure of project details.

## Setup Instructions

### Initial Setup (New Developer)

1. **Install FlutterFire CLI**

   ```bash
   dart pub global activate flutterfire_cli
   ```

2. **Login to Firebase**

   ```bash
   firebase login
   ```

3. **Select Firebase Project**

   ```bash
   firebase use --add
   # Select the appropriate project (staging or production)
   ```

4. **Configure FlutterFire**

   ```bash
   flutterfire configure
   ```

   This will:

   - Detect your Flutter platforms
   - Generate `lib/firebase_options.dart`
   - Create/update `android/app/google-services.json`
   - Create/update `ios/Runner/GoogleService-Info.plist`

### Verifying Configuration

Run this command to verify Firebase is properly configured:

```bash
flutter run
```

Check the console for:

```
✓ Firebase initialized successfully
✓ Firebase App Check activated
✓ Performance monitoring enabled
```

### Updating Firebase Configuration

When Firebase project settings change (e.g., adding new services):

```bash
flutterfire configure --reconfigure
```

## Firebase Project Structure

### Project ID

- `sierra-painting` (as configured in `firebase_options.dart`)

### Environment Aliases

- `staging` - Development and testing environment
- `prod` - Production environment

Switch between environments:

```bash
firebase use staging  # For development
firebase use prod     # For production deploys
```

## Security Configuration

### App Check

Firebase App Check is enabled to protect backend resources from abuse:

- **Android**: Play Integrity API (production) / Debug provider (development)
- **iOS**: App Attest (production) / Debug provider (development)
- **Web**: ReCaptcha v3 (requires site key configuration)

Enable/disable App Check via Dart define:

```bash
flutter run --dart-define=ENABLE_APP_CHECK=true
```

**Default**: Enabled in release mode, disabled in debug mode

### Security Rules

Firebase security rules are defined in:

- `firestore.rules` - Firestore database rules
- `storage.rules` - Cloud Storage rules

Deploy rules:

```bash
firebase deploy --only firestore:rules,storage
```

## Firebase Services Configuration

### 1. Authentication

**Enabled Providers:**

- Email/Password

**Sign-in Methods:** Configure in Firebase Console → Authentication → Sign-in method

### 2. Firestore

**Configuration:**

- Mode: Production (secure rules required)
- Location: us-east4 (or configured region)
- Offline persistence: Enabled

**Indexes:** Defined in `firestore.indexes.json` and deployed with:

```bash
firebase deploy --only firestore:indexes
```

### 3. Cloud Functions

**Runtime:** Node.js 18+ **Location:** us-east4

Deploy functions:

```bash
cd functions && npm run deploy
```

### 4. Storage

**Buckets:**

- Default bucket for user uploads
- Security rules enforce authentication

### 5. Remote Config

**Feature Flags:** Configure in Firebase Console → Remote Config

**Parameters:**

- `feature_*_enabled` - Feature toggles
- Defaults defined in `lib/core/services/feature_flag_service.dart`

### 6. Performance Monitoring

**Automatic Traces:**

- App startup
- Screen transitions (via GoRouter)
- Network requests

**Custom Traces:** Add in code:

```dart
final trace = FirebasePerformance.instance.newTrace('my_operation');
await trace.start();
// ... operation
await trace.stop();
```

### 7. Crashlytics

**Configuration:** Automatically captures:

- Fatal crashes
- Dart exceptions
- Flutter errors

**Manual logging:**

```dart
FirebaseCrashlytics.instance.recordError(error, stackTrace);
```

## Environment Variables

Optional environment variables for Firebase configuration:

```bash
# .env (not committed)
ENABLE_APP_CHECK=true
FIREBASE_PROJECT_ID=sierra-painting
```

## Testing with Firebase

### Unit Tests

Mock Firebase services using `mockito`:

```dart
class MockFirebaseAuth extends Mock implements FirebaseAuth {}
```

### Integration Tests

Use Firebase Local Emulator Suite:

```bash
firebase emulators:start
```

Configure emulator in test setup:

```dart
await FirebaseAuth.instance.useAuthEmulator('localhost', 9099);
await FirebaseFirestore.instance.useFirestoreEmulator('localhost', 8080);
```

## Troubleshooting

### Issue: "Firebase not initialized"

**Solution:**

```dart
WidgetsFlutterBinding.ensureInitialized();
await Firebase.initializeApp(
  options: DefaultFirebaseOptions.currentPlatform,
);
```

### Issue: "google-services.json not found"

**Solution:** Run `flutterfire configure` to regenerate platform files.

### Issue: "App Check verification failed"

**Solution:**

1. Verify App Check is enabled in Firebase Console
2. Register debug tokens for development
3. Check platform-specific setup (Play Integrity for Android, App Attest for iOS)

### Issue: "Firestore permission denied"

**Solution:**

1. Check Firestore rules in `firestore.rules`
2. Verify user is authenticated
3. Ensure RBAC is properly configured

## Firebase Console Access

Access the Firebase Console at: https://console.firebase.google.com/

**Required Permissions:**

- Editor role for deployment
- Viewer role for monitoring

## Deployment Checklist

Before deploying to production:

- [ ] Firebase configuration is up to date (`flutterfire configure`)
- [ ] Security rules deployed and tested
- [ ] App Check enabled and verified
- [ ] Performance monitoring active
- [ ] Crashlytics configured with proper symbolication
- [ ] Analytics tracking events defined
- [ ] Feature flags configured in Remote Config
- [ ] Environment variables set in CI/CD

## References

- [FlutterFire Documentation](https://firebase.flutter.dev/)
- [Firebase Console](https://console.firebase.google.com/)
- [Firebase CLI Reference](https://firebase.google.com/docs/cli)
- [App Check Setup](https://firebase.google.com/docs/app-check)
- Project Documentation: `docs/ONBOARDING.md`
