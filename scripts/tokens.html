<!doctype html>
<meta charset="utf-8" />
<title>Firebase Token Probe</title>
<pre id="out">Loading…</pre>
<script type="module">
  // ---- URL params ----
  const url = new URL(location.href);
  const email = url.searchParams.get("email") || "";
  const pass  = url.searchParams.get("pass")  || "";
  const siteKey = url.searchParams.get("recaptcha") || ""; // optional ?recaptcha=SITE_KEY
  const debugFlag = url.searchParams.get("debug") === 'true' || url.searchParams.get("debug") === '1';

  // ---- Firebase SDKs (v11) ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { initializeAppCheck, ReCaptchaV3Provider, getToken as getAppCheckToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app-check.js";

  // TODO: fill in your real config
  // Default embedded config (fallback). Prefer creating scripts/firebase_config.json with real values.
  const fallbackConfig = {
    apiKey: "AIzaSyAJizvq82-zsud2NLtp_AtiboIV7mn2WOs",
    authDomain: "your-project-id.firebaseapp.com",
    projectId: "to-do-app-ac602",
    appId: "1:138777646966:web:4d2b7855b2cb2b0c7e0c57",
    recaptcha: "6Lclq98rAAAAAHR8xPb6c8wYsk3BZ_K6g2ztur63"
  };

  // Attempt to load an explicit config file generated from .env: scripts/firebase_config.json
  async function loadFirebaseConfig() {
    try {
      const res = await fetch('/scripts/firebase_config.json', { cache: 'no-store' });
      if (res.ok) {
        const j = await res.json();
        console.log('Loaded firebase config from /scripts/firebase_config.json');
        return j;
      }
    } catch (e) {
      // ignore and fallback
    }
    console.log('Using embedded fallback firebaseConfig');
    return fallbackConfig;
  }

  const out = document.getElementById("out");
  const log = (msg) => { console.log(msg); out.textContent += (out.textContent ? "\n" : "") + msg; };

  try {
  out.textContent = "Initializing Firebase…";
  const firebaseConfig = await loadFirebaseConfig();
  const app = initializeApp(firebaseConfig);

    // ---- App Check: reCAPTCHA v3 or DEBUG fallback ----
    let appCheck;
    if (siteKey) {
      appCheck = initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider(siteKey),
        isTokenAutoRefreshEnabled: true
      });
      log("App Check: reCAPTCHA v3 enabled.");
      // Try a grecaptcha.execute timing for v3/enterprise (best-effort)
      try {
        if (window.grecaptcha && typeof window.grecaptcha.execute === 'function') {
          log('Attempting grecaptcha.execute to prime App Check...');
          window.grecaptcha.execute(siteKey, {action: 'validate'}).then(t => console.log('grecaptcha.execute token', t)).catch(e => console.warn('grecaptcha.execute failed', e));
        }
      } catch (e) { console.warn('grecaptcha.execute attempt error', e); }
    } else {
      // Debug mode (no site key needed)
      // If you want to register a debug token, open DevTools Console and copy the printed token.
      // Set FIREBASE_APPCHECK_DEBUG_TOKEN to true to enable the SDK's debug behavior.
      self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
      appCheck = initializeAppCheck(app, { provider: new ReCaptchaV3Provider("debug"), isTokenAutoRefreshEnabled: true });
      log("App Check: DEBUG token mode.");
      if (debugFlag) {
        try {
          // The SDK prints the debug token to console; also print to #out for the validator to capture
          const dbg = self.FIREBASE_APPCHECK_DEBUG_TOKEN || 'true';
          log('App Check DEBUG token (SDK may print a real value in devtools): ' + String(dbg));
        } catch (e) { console.warn('debug token print failed', e); }
      }
    }

    // ---- Auth ----
    const auth = getAuth(app);
    if (!email || !pass) throw new Error("Missing credentials (?email=&pass=).");
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    log(`Signed in as ${cred.user.email}`);

    // ---- Tokens ----
    const idToken = await cred.user.getIdToken(/* forceRefresh */ true);
    log(`ID Token (preview): ${idToken ? idToken.substring(0,24) + '…' : 'none'}`);

  const appCheckToken = await getAppCheckToken(appCheck); // pass the appCheck instance
  log(`AppCheck token (preview): ${appCheckToken?.token ? (appCheckToken.token.substring(0,24) + '…') : 'none'}`);

  // Final concise two-line output expected by the validator
  out.textContent = `ID Token: ${!!idToken}\nApp Check Token: ${!!appCheckToken?.token}`;
  } catch (e) {
    console.error(e);
    out.textContent = `ERROR: ${e?.message || e}`;
  }
</script>
