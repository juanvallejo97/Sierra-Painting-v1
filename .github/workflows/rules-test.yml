name: Security - Firestore Rules

on:
  pull_request:
    branches: [main]
    paths:
      - 'firestore.rules'
      - 'firestore-tests/**'
      - '.github/workflows/rules-test.yml'
  push:
    branches: [main]
    paths:
      - 'firestore.rules'
      - 'firestore-tests/**'

jobs:
  rules:
    name: rules
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Java for Firebase emulator
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Install test dependencies
        working-directory: firestore-tests
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi
      
      - name: Start Firestore Emulator
        run: |
          # Create a minimal firebase.json if needed
          if [ ! -f firebase.json ]; then
            echo '{"emulators": {"firestore": {"port": 8080}}}' > firebase.json
          fi
          
          # Start emulator in the background
          firebase emulators:start --only firestore --project demo-test &
          EMULATOR_PID=$!
          echo "EMULATOR_PID=$EMULATOR_PID" >> $GITHUB_ENV
          
          # Wait for emulator to be ready (max 60 seconds)
          echo "Waiting for Firestore emulator to start..."
          for i in {1..60}; do
            if curl -s http://localhost:8080 > /dev/null 2>&1; then
              echo "✅ Firestore emulator is ready!"
              exit 0
            fi
            sleep 1
          done
          
          echo "❌ ERROR: Firestore emulator failed to start"
          exit 1
        timeout-minutes: 2
      
      - name: Run Firestore Rules tests
        working-directory: firestore-tests
        run: npm test
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
      
      - name: Stop Firestore Emulator
        if: always()
        run: |
          if [ ! -z "$EMULATOR_PID" ]; then
            kill $EMULATOR_PID || true
          fi
          pkill -f "firebase.*emulator" || true
          pkill -f "firestore.*emulator" || true
