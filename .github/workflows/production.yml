name: Production CI/CD Pipeline

on:
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: 'stable'
  NODE_VERSION: '18'
  JAVA_VERSION: '17'
  FIREBASE_PROJECT_PROD: 'sierra-painting-prod'

jobs:
  setup:
    name: Setup and Cache Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-key-flutter: ${{ steps.cache-keys.outputs.flutter }}
      cache-key-npm: ${{ steps.cache-keys.outputs.npm }}
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Get version from tag
        id: get-version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Check for VERIFICATION_CHECKLIST.md
        run: |
          if [ ! -f VERIFICATION_CHECKLIST.md ]; then
            echo "::error::VERIFICATION_CHECKLIST.md is required for production releases"
            exit 1
          fi
          echo "✅ VERIFICATION_CHECKLIST.md found"

      - name: Generate cache keys
        id: cache-keys
        run: |
          echo "flutter=${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}" >> $GITHUB_OUTPUT
          echo "npm=${{ runner.os }}-npm-${{ hashFiles('**/functions/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            build
          key: ${{ steps.cache-keys.outputs.flutter }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Install Functions dependencies
        working-directory: ./functions
        run: npm ci

  lint_and_test_flutter:
    name: Lint and Test Flutter
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            build
          key: ${{ needs.setup.outputs.cache-key-flutter }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      - name: Run Flutter analyze
        run: flutter analyze --fatal-infos

      - name: Run Flutter tests
        run: flutter test

  lint_and_test_functions:
    name: Lint and Test Functions
    runs-on: ubuntu-latest
    needs: setup
    defaults:
      run:
        working-directory: functions
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: |
          if grep -q '"lint"' package.json; then
            npm run lint
          else
            echo "No lint script found, skipping..."
          fi

      - name: Run tests
        run: |
          if grep -q '"test"' package.json; then
            npm test
          else
            echo "No test script found, skipping..."
          fi

  build_flutter_release:
    name: Build Flutter Release APK/AAB
    runs-on: ubuntu-latest
    needs: [setup, lint_and_test_flutter]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            build
          key: ${{ needs.setup.outputs.cache-key-flutter }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK (release)
        run: flutter build apk --release --dart-define=ENABLE_APP_CHECK=true

      - name: Build AAB (release)
        run: flutter build appbundle --release --dart-define=ENABLE_APP_CHECK=true

      - name: Generate SBOM
        run: |
          echo "Generating Software Bill of Materials..."
          flutter pub deps --json > sbom-flutter.json
          echo "Flutter SBOM generated"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-builds-${{ needs.setup.outputs.version }}
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
            sbom-flutter.json
          retention-days: 90

  smoke_tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: [build_flutter_release, lint_and_test_functions]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run minimal integration smoke
        run: flutter test integration_test/app_boot_smoke_test.dart

      - name: Produce smoke summary
        run: dart run tool/smoke/smoke.dart

      - name: Upload smoke results
        uses: actions/upload-artifact@v4
        with:
          name: smoke-results-production
          path: build/smoke/smoke_results.json
          if-no-files-found: warn
          retention-days: 14

  deploy_indexes_production:
    name: Deploy Firestore Indexes (Production)
    runs-on: ubuntu-latest
    needs: [smoke_tests]
    environment:
      name: production
      url: https://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_PROD }}/overview
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Deploy Firestore indexes
        run: |
          firebase deploy --only firestore:indexes --project ${{ env.FIREBASE_PROJECT_PROD }} --non-interactive

  deploy_functions_production:
    name: Deploy Functions to Production
    runs-on: ubuntu-latest
    needs: [deploy_indexes_production]
    environment:
      name: production
      url: https://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_PROD }}/functions
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install Functions dependencies
        working-directory: ./functions
        run: npm ci

      - name: Build Functions
        working-directory: ./functions
        run: npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Firebase login guard check
        run: |
          chmod +x scripts/ci/firebase-login.sh
          ./scripts/ci/firebase-login.sh

      - name: Deploy to Firebase Production
        run: |
          echo "Deploying to production with canary strategy..."
          echo "Note: After deployment, use scripts/promote_canary.sh to control traffic split"
          firebase deploy --only functions,firestore:rules,storage:rules --project ${{ env.FIREBASE_PROJECT_PROD }} --non-interactive --force
        continue-on-error: false

  create_github_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [setup, deploy_functions_production, build_flutter_release]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download build artifacts
        uses: actions/download-artifact@v5
        with:
          name: release-builds-${{ needs.setup.outputs.version }}
          path: ./release-builds

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./release-builds/app-release.apk
            ./release-builds/app-release.aab
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## Sierra Painting ${{ needs.setup.outputs.version }}

            ### 📱 Mobile App Builds
            - **APK**: app-release.apk (for direct installation)
            - **AAB**: app-release.aab (for Google Play Store)

            ### 🚀 Deployment
            - Cloud Functions deployed to production
            - Firestore rules and indexes updated
            - Storage rules updated

            ### 📊 Monitoring
            - [Firebase Console](https://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_PROD }}/overview)
            - [Cloud Functions Logs](https://console.cloud.google.com/logs/query?project=${{ env.FIREBASE_PROJECT_PROD }})
            - [Crashlytics](https://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_PROD }}/crashlytics)

            ### 📝 Notes
            - Manual app store submission required for iOS
            - Monitor error rates for 24 hours post-deployment
            - See [rollout-rollback.md](https://github.com/${{ github.repository }}/blob/main/docs/rollout-rollback.md) for rollback procedures

  post_checks:
    name: Post-Deployment Checks
    runs-on: ubuntu-latest
    needs: [deploy_functions_production, create_github_release]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Post-deployment verification
        run: |
          echo "Running post-deployment verification..."
          if [ -f "scripts/deploy/verify.sh" ]; then
            chmod +x scripts/deploy/verify.sh
            ./scripts/deploy/verify.sh --env prod --quick || echo "⚠️  Verification completed with warnings"
          else
            echo "⚠️  Verification script not found"
          fi

      - name: Print monitoring links
        run: |
          echo "==================================================="
          echo "📊 Production Environment Monitoring Links"
          echo "==================================================="
          echo ""
          echo "🔥 Firebase Console:"
          echo "https://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_PROD }}/overview"
          echo ""
          echo "📝 Cloud Functions Logs:"
          echo "https://console.cloud.google.com/logs/query?project=${{ env.FIREBASE_PROJECT_PROD }}"
          echo ""
          echo "💥 Crashlytics Dashboard:"
          echo "https://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_PROD }}/crashlytics"
          echo ""
          echo "⚡ Performance Monitoring:"
          echo "https://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_PROD }}/performance"
          echo ""
          echo "🔍 Error Reporting:"
          echo "https://console.cloud.google.com/errors?project=${{ env.FIREBASE_PROJECT_PROD }}"
          echo ""
          echo "🎮 Google Play Console:"
          echo "https://play.google.com/console"
          echo ""
          echo "🍎 App Store Connect:"
          echo "https://appstoreconnect.apple.com"
          echo ""
          echo "==================================================="
          echo "📋 Post-Deployment Checklist"
          echo "==================================================="
          echo ""
          echo "Automated checks via verify.sh:"
          echo "  - [x] Function availability"
          echo "  - [ ] Error rate < 1% (manual check required)"
          echo "  - [ ] P95 latency < 2s (manual check required)"
          echo ""
          echo "Key User Journeys (manual verification required):"
          echo "  - [ ] Login (email/password)"
          echo "  - [ ] Estimate creation"
          echo "  - [ ] Invoice export"
          echo ""
          echo "SLO Targets for Production:"
          echo "  - Error Rate: < 1%"
          echo "  - P95 Latency: < 2s"
          echo "  - Function Availability: > 99.9%"
          echo "  - Cold Start: < 5s"
          echo ""
          echo "Manual verification steps:"
          echo "  1. Check Cloud Functions logs for errors (next 2 hours)"
          echo "  2. Monitor Crashlytics for new crashes (next 24 hours)"
          echo "  3. Test critical user flows in production app"
          echo "  4. Monitor error rate and latency metrics"
          echo "  5. Upload APK/AAB to Play Store (manual step)"
          echo "  6. Submit iOS build to App Store (manual step)"
          echo ""

      - name: Deployment status
        run: |
          if [ "${{ needs.deploy_functions_production.result }}" == "success" ]; then
            echo "✅ Production deployment completed successfully!"
            echo ""
            echo "🚦 Canary Deployment:"
            echo "  The deployment is initially at 100% traffic."
            echo "  For safer rollouts, use canary deployment:"
            echo "    ./scripts/deploy_canary.sh --project sierra-painting-prod"
            echo "  Then promote when metrics are good:"
            echo "    ./scripts/promote_canary.sh --project sierra-painting-prod"
            echo ""
            echo "⚠️  Critical Post-Deployment Actions:"
            echo "  1. Monitor production for next 2 hours"
            echo "  2. Have rollback plan ready (see scripts/rollback/)"
            echo "  3. Upload builds to app stores (manual)"
            echo "  4. Announce release to team/users"
            echo ""
          else
            echo "❌ Production deployment failed!"
            echo "Check the logs above for errors."
            echo "Rollback may be required!"
            exit 1
          fi
