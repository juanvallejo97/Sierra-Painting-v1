name: p0.5_functions_build_green
goal: "TypeScript compiles with no errors; predeploy guard in place."
why: "Prevents stale/broken Functions from deploying."

touches:
  - functions/package.json
  - functions/tsconfig.json
  - functions/src/**/*.ts

prechecks:
  - "Node 18+ or 20+, npm 9+ available."
  - "From repo root: run all commands with --prefix functions."

steps:
  - "Install clean deps: npm --prefix functions ci"

  - "Ensure scripts exist (edit package.json if missing): scripts: build: tsc -p . typecheck: tsc
    --noEmit -p . lint: eslint . --ext .ts || echo 'eslint not configured'"

  - "Compile: npm --prefix functions run build"

  - "If build fails, fix errors in src until exit code 0."

  - 'Verify predeploy hook (firebase.json): hosting/functions predeploy should include: ''npm
    --prefix "$RESOURCE_DIR" run build'' # If absent, add under ''functions'': { ''predeploy'':
    [''npm --prefix "$RESOURCE_DIR" run build''] }'

validation:
  - "Exit code 0 from: npm --prefix functions run build"
  - "Optional: npm --prefix functions run typecheck returns 0"
  - "Optional: npm --prefix functions run lint returns 0"

deliverable:
  - "Commit: chore(functions): build green & enforce predeploy build"
